# TCL - Transaction Control Language

> Логическая группа операций, выполняется только целиком

> Все операции обёрнуты в транзакции.

Пример: банковская транзакция

* прочесть баланс на счету X
* уменьшить баланс на Z денежных единиц
* сохранить новый баланс счёта X
* прочесть баланс на счету Y
* увеличить баланс на Z денежных единиц
* сохранить новый баланс счёта Y

## ACID 

> Требования к транзакциям 

### Atomicity (атомарность)

Гарантирует полное выполнение или отсутсвия модификации(частичное изминение не возможно).

Если действие не завершено, то произойдет роллбек и система вернется в начальное состояние

### Consistency (консистентность / согласованность)

Выполняет требование к согласованности данных, то есть система не сможет наршить ограничения/тригерры наложенные на данные.

### Isolation (изолированность)

Без изолированности, не возможно поддерживать согласованность. Изолированность гарантирует не возможность чтения другими транзакциями не согласованные данные. Данные одной транзакции, изолируются от других транзакций на время требуемое исходной транзакции для выполнения всех необходимых ему действий.

| Уровень изоляции | «Грязное» чтение | Неповторяемое чтение | Фантомное чтение | Аномалия сериализации |
| --- | --- | --- | --- | --- |
| Read uncommited (Чтение незафиксированных данных) | Допускается, но не в PG | Возможно | Возможно | Возможно |
| Read committed (Чтение зафиксированных данных) | Невозможно | Возможно | Возможно | Возможно |
| Repeatable read (Повторяемое чтение) | Невозможно | Невозможно | Допускается, но не в PG | Возможно |
| Serializable (Сериализуемость) | Невозможно | Невозможно | Невозможно | Невозможно |

Без изолированности, мы бы в системе имели такие проблемы параллельности:
* «Грязное» чтение - чтение частичных изменений
* Неповторяемое чтение - повторное чтение показывает, что данные были изменены после первого чтения
* Фантомное чтение - повторное чтение показывает другой результирующий набор
* Аномалия сериализации - результат параллельно выполняемых транзакций может не согласовываться с результатом этих же транзакций, выполняемых по очереди

В PG построенная система изоляция на основе MVCC(multiversion control system) - то есть изменения версионируются таймштампом и далее ориентируется по ним, что снижает потребность в блокировках

#### Как использовать?

```sql
    -- В начале транзакции:
    BEGIN ISOLATION LEVEL level
    
    -- Внутри транзакции:
    SET TRANSACTION ISOLATION LEVEL level
```

### Durability (долговечность)

Если транзакция выполнилась, то никакие сбои не вызовут откаты действий.

## Syntax

### SQL standard

```sql
    START TRANSACTION / BEGIN [TRANSACTION]
    END [TRANSACTION] / COMMIT
    BEGIN / COMMIT
```

### PgSQL extension:

```sql
    START TRANSACTION / END [TRANSACTION]
```


### Откатить

```sql
    ROLLBACK
```

* `RAISE EXCEPTION` - прервать транзакцию изнутри функции
* `SAVEPOINT savepoint_name` - делает «засечки» в «важных» местах и затем откатиться к этой точке `ROLLBACK TO savepoint_name`
* `BEGIN и EXCEPTION WHEN` - если нужно откатить только часть, то можно «имитировать» savepoint с помощью этих команд
* 

